var typingBreak=null;addWebSocketEventListener("message",function(i){var f=JSON.parse(i.data);var c=$(".block-conversation");var o=c.find(".messages-container");var h=window.innerHeight+window.scrollY>=document.body.offsetHeight-15;switch(f.type){case"read":var g=o.find(".message-item.is-unread");var k=$('.badge.badge--conversation:not([data-badge="0"])');var n=parseInt(k.attr("data-badge"))-g.length;k.attr("data-badge",n<0?0:n);g.removeClass("is-unread");break;case"typing":var l=$(".block-conversation.block-conversation--"+f.conv_id+" .messages-container");if(l.find(".typing-message").length===0){l.append('<div class="typing-message">'+f.username+" набирает сообщение</div>");if(h){scrollDown()}}clearTimeout(typingBreak);typingBreak=setTimeout(function(){l.find(".typing-message").remove()},3000);break;case"message":var d=f.user;var a=f.receiver;if(c.data("receiver")===d||c.data("receiver")===a){if(o.length>0){o.find(".empty-message").remove();o.find(".typing-message").remove();o.append(f.chat_message);var m=$(".message-receiver").data("user-id");if(m===d){if(!document.hidden){read()}}}if(h){scrollDown()}}var b=$(".block-dialogs");var j=b.find('.conv-item[data-conv="'+f.conv_id+'"]');if(j.data("receiver")===a){j.html(f.dialog_update_sender)}else{j.html(f.dialog_update_receiver)}break}});$(document).ready(function(){read()});var afterClick=false;$(window).on("resize",function(){if(afterClick){scrollDown();afterClick=false}});$(window).on("focus blur",function(){read()});var typingTimeout=null;$("body").on("input",'input[name="message"]',function(c){var b=$(".message-editor");var a=$(c.target);if(a.val().trim().length===0){b.addClass("is-empty")}else{b.removeClass("is-empty")}if(typingTimeout===null){$.ajax({url:location.href+"/typing",type:"post",success:function(){typingTimeout=setTimeout(function(){typingTimeout=null},3000)}})}}).on("submit",".message-editor",function(f){f.preventDefault();var d=$(f.target);var c=d.attr("action");var a=d.find('input[name="message"]');var b=a.val();if(b.trim().length===0){a.addTemporaryClass("input-error",250);return}a.val("");d.addClass("is-empty");$.ajax({url:c,type:"post",data:{message:b},success:function(){scrollDown()}})}).on("click",'.message-editor input[name="message"]',function(){var a=window.innerHeight+window.scrollY>=document.body.offsetHeight-30;if(a){afterClick=true}});function read(){var d=$(".block-conversation");var a=d.find(".messages-container");var b=a.find(".message-item.is-unread");if(b.length===0){return}var c=b.data("user-id");if(c!==user_id){$.ajax({type:"post",url:location.href+"/read"})}}function load(a){$.ajax({url:a,type:"post",data:{ajax:true},success:function(b){$(".body-content").html(b);scrollDown();read()}})}function scrollDown(){$("html, body").animate({scrollTop:$(document).height()-$(window).height()},1)}$(".body-content").on("click","a",function(c){var b=$(c.target);if(b.hasClass("no-ajax")||b.parent().parent().hasClass("messages-container")){return}c.preventDefault();var a=b.attr("href");if(a){if(a.endsWith("conv")){$(".block-conversation").addClass("is-hide");$(".block-dialogs").removeClass("is-selected")}else{if(b.hasClass("conv-item")){$(".block-dialogs").find(".conv-item.is-selected").removeClass("is-selected");b.addClass("is-selected");$(".block-conversation").addClass("is-loading")}}load(a);window.history.pushState({state:"new"},"",a)}});window.onpopstate=function(){load(location.href)};