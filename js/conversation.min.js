!function(e,g,p){var a={};var l=0;var i=e(".block-dialogs");var s=e(".block-conversation");var d=s.find(".block-header");var j=s.find(".block-messages .messages-container");var h=s.find(".message-editor");var f=function(x){x=e.extend({Conversation:null,conversation_id:0,date:"",is_read:false,message:"",message_id:0,sender_User:core.visitor,sender_user_id:core.visitor.user_id},x||{});return x};var b=function(A,z,y){var x=A.sender_User;var B=A.date.split(" ",2);return e('<div class="message-item'+(!A.is_read?" is-unread":"")+(A.sender_user_id===core.visitor.user_id?" is-you":"")+'" data-sender="'+x.user_id+'" data-message-id="'+A.message_id+'"><div class="message"><'+(z===true?"span":"a")+' class="message-user"'+(z===true?"":' href="'+core.root+"/id"+x.user_id+'"')+">"+x.username+"</"+(z===true?"span":"a")+'> <span class="message-text">'+A.message+'</span><span class="message-date">'+(y===true&&B[1]!==undefined?B[1]:A.date)+"</span></div></div>")};function u(y,z){var E=h.find('.input[name="message"]');E.html("");h.addClass("is-empty");if(l>0){if(e(g).scrollTop()+e(g).height()>=e(p).height()-5){a[l]["scroll"]=-1}else{a[l]["scroll"]=g.scrollY}}l=-1;if(!y||y===0){i.removeClass("is-selected").find("li a").removeClass("is-selected");s.removeClass("is-active").removeClass("is-loading");return}y=parseInt(y);i.find("li a.is-selected").removeClass("is-selected");i.addClass("is-selected").find('li a[data-conv="'+y+'"]').addClass("is-selected");if(z&&a.hasOwnProperty(y)===false){l=0;s.addClass("is-loading");m(y,function(){u(y,false)});return}var F=a[y];if(F===undefined){return}j.html("");l=y;var x=F.receiver;s.attr("data-receiver",x.user_id);d.find(".message-receiver").attr("href",core.root+"/id"+x.user_id).html(x.username);var B=F.messages;if(B.length===0){j.append('<div class="empty-message">У вас еще не было диалога с '+x.username+"</div>")}else{for(var C in F.messages){var A=F.messages[C];var D=A.date.split(" ",2);if(j.find('.message-date-separator[data-date="'+D[0]+'"]').length===0){j.append('<div class="message-date-separator" data-date="'+D[0]+'"></div>')}j.append(b(A,false,true))}}s.addClass("is-active").removeClass("is-loading");h.attr("action",core.root+"/conv"+y+"/send");E.html(a[l]["last_message"]);E.trigger("input");w(a[l]["scroll"]);r()}function m(y,x){if(!y||y===0||y===undefined){return}e.ajax({type:"post",url:core.root+"/conv"+y,data:{ajax:true},success:function(z){var A=JSON.parse(z);var B=A.conv;B.receiver=A.receiver;B.messages=A.messages;B.last_message=A.last_message;B.page=0;B.scroll=-1;a[B.conversation_id]=B;if(x&&l>-1){x()}}})}function r(){var x=[];j.find('.message-item.is-unread:not([data-sender="'+core.visitor.user_id+'"]').each(function(){var y=e(this);if(y.isVisible(86)){x.push(y.data("message-id"))}});if(x.length>0){e.ajax({url:core.root+"/conv"+l+"/read",type:"post",data:{m:x.join(",")}})}}function k(){return g.innerHeight+g.scrollY>=p.body.offsetHeight-15}function w(x){if(x!==undefined&&x!==-1){e("html, body").animate({scrollTop:x},1)}else{var z=j.find('.message-item.is-unread:not([data-sender="'+core.visitor.user_id+'"]):first');var y=z.length>0?z.offset().top+z.addTemporaryClass("is-highlight",1000).height()+71:e(p).height();e("html, body").animate({scrollTop:(y-e(g).height())},1)}}var o=null;function c(x){if(o===null){e.ajax({url:core.root+"/conv"+l+"/typing",type:"post",data:{state:"start",message:x}})}clearTimeout(o);o=setTimeout(function(){e.ajax({url:core.root+"/conv"+l+"/typing",type:"post",data:{state:"stop",message:x}});o=null},1000)}var t=false;function v(){if(l===0||a[l]["messages"].length<20||t){return}var y=l;var x=a[l]["messages"].length;e.ajax({url:core.root+"/conv"+l,type:"post",data:{ajax:true,loaded:x},success:function(H){var B=JSON.parse(H);if(B.messages.length===0){t=true;return}a[l]["messages"]=B.messages.concat(a[l]["messages"]);a[l]["loaded"]+=B.messages.length;if(y!==l){return}var F=100;var E=g.scrollY;for(var C=B.messages.length;C>0;C--){var A=B.messages[C-1];var z=b(A,false,true);var D=A.date.split(" ",2);j.prepend(z);F+=z.outerHeight();var G=j.find('.message-date-separator[data-date="'+D[0]+'"]');if(G.length===0){G=j.prepend('<div class="message-date-separator" data-date="'+D[0]+'"></div>').find('.message-date-separator[data-date="'+D[0]+'"]');F+=G.outerHeight()}}e("html, body").animate({scrollTop:E+F},1)}})}core.addWebSocketEventListener("message",function(G){var E=JSON.parse(G.data);var K=E.type;console.log(E);var L=k();var A=E.conv_id;var I=i.find('.conv-item[data-conv="'+A+'"]');var F=parseInt(I.attr("data-unread"));switch(K){case"new_message":var M=E.message;var J=b(M,false,true);if(l===A){j.find(".empty-message").remove();j.find(".typing-message").remove();var z=j.find('.message-item[data-message-id="0"]:first');var H=M.date.split(" ",2);if(core.visitor.user_id===M.sender_user_id&&z.length>0){z.html(J.html()).attr("data-message-id",M.message_id).removeClass("is-loading")}else{j.append(J)}if(j.find('.message-date-separator[data-date="'+H[0]+'"]').length===0){j.find('.message-item[data-message-id="'+M.message_id+'"]').before('<div class="message-date-separator" data-date="'+H[0]+'"></div>')}o=null;if(L){w()}}if(!p.hidden){r()}if(a.hasOwnProperty(A)){a[A]["messages"].push(M);a[A]["last_message_id"]=M.message_id}var D=M.sender_user_id;if(D!==core.visitor.user_id){I.attr("data-unread",F+1)}var x=core.visitor.user_id===M.Conversation["first_user_id"]?M.Conversation["second_User"]:M.Conversation["first_User"];if(I.length===0){i.find("li span.conv-item").parent().remove();I=i.prepend('<li><a data-unread="'+(core.visitor.user_id===M.sender_user_id?"0":"1")+'" data-receiver="'+x.user_id+'" data-conv="'+A+'" class="conv-item" href="'+core.root+"/conv"+A+'"><span class="message-user">'+x.username+'</span> <span class="message-text"></span><span class="message-date"></span></a>').find('.conv-item[data-conv="'+A+'"]')}else{I.parent("li").remove();I=i.prepend("<li>"+I.parent().html()+"</li>").find('.conv-item[data-conv="'+A+'"]')}if(l===A){i.find(".conv-item.is-selected").removeClass("is-selected");I.addClass("is-selected")}I.find(".message-text").html((core.visitor.user_id===M.sender_user_id?"<i>(Вы)</i> ":"")+M.message.replace(/<br\s?\/?>/g," "));I.find(".message-date").html(M.date);I.find(".message-typing").remove();break;case"read":var B=E.messages;for(var C in B){var y=B[C];if(A===l){j.find('.message-item.is-unread[data-message-id="'+y+'"]').removeClass("is-unread")}a[l]["messages"][C]["is_read"]=true}I.attr("data-unread",Math.max(F-B.length,0));break;case"typing_message":if(E.state==="start"){if(A===l){if(j.find(".typing-message").length===0){j.append('<div class="typing-message">'+E.typer["username"]+" набирает сообщение</div>");if(L){w()}}}else{I.find(".message-user").after('<span class="message-typing">&nbsp;печатает</span>')}}else{j.find(".typing-message").remove();I.find(".message-typing").remove()}}});var n=false;e(g).on("resize",function(){if(n){w();n=false}});var q=null;e(p).on("scroll",function(){if(l>0&&g.scrollY===0){v()}clearTimeout(q);q=setTimeout(function(){r();q=null},1000)}).on("click focus blur",r);e(g).on("focus blur",r);e("body").on("click",".block.block-inline a, .alert .alert-content",function(A){var y=e(this);var x=y.attr("href");if(!x.startsWith(core.root+"/conv")){return}A.preventDefault();var z=y.attr("data-conv");if(z===undefined){z=""}u(z,true);history.pushState({state:"new"},"",core.root+"/conv"+z)});e(".message-editor").on("submit",function(D){D.preventDefault();var A=e(this);var x=A.find('.input[name="message"]');x.focus();if(x.text().trim().length===0){x.addTemporaryClass("input-error",250);return}var B=x.safeText();var C=A.attr("action");A.addClass("is-empty");var E=f({message:B});var y=b(E,false,true);y.addClass("is-loading");var z=k();j.append(y);if(z){w()}s.find(".empty-message").remove();x.html("");a[l]["last_message"]="";e.ajax({url:C,type:"post",data:{message:B}})}).on("paste",'.input[name="message"]',function(A){A.preventDefault();if(g.clipboardData){var y=g.clipboardData.getData("Text");if(g.getSelection){var z=g.getSelection();var x=z.getRangeAt(0);x.deleteContents();x.insertNode(p.createTextNode(y))}}else{if(A.originalEvent.clipboardData){y=(A.originalEvent||A).clipboardData.getData("text/plain");p.execCommand("insertText",false,y)}}}).on("input",'.input[name="message"]',function(){var y=e(this);var z=e(this).parent();if(y.text().trim().length===0){z.addClass("is-empty")}else{z.removeClass("is-empty")}var A=y.safeText();var x=a[l]["last_message"];if(y.text().trim().length>0&&Math.abs(x.length-A.length)>0){c(A);a[l]["last_message"]=A}if(n){w();n=false}}).on("click",function(){if(k()){n=true}});e(p).on("keypress",function(y){var x=e(".message-editor .input:focus");if(x.length>0){if(g.innerWidth>700&&y.which===13&&!y.shiftKey){y.preventDefault();x.parent().trigger("submit")}if(k()){n=true}}});g.onpopstate=function(){var x=location.pathname;var y=x.replace(new RegExp("^"+core.root+"/conv",""),"");u(y,true)};u(s.data("conv"),true)}(jQuery,window,document);